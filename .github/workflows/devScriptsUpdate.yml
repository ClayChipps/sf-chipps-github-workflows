on:
  workflow_call:

jobs:
  # what is the RC version, numerically?
  compareVersions:
    outputs:
      shouldUpdate: ${{steps.packageVersion.outputs.prop != steps.version-info.outputs.version}}

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - uses: salesforcecli/github-workflows/.github/actions/versionInfo@main
        id: version-info
        with:
          version: latest
          npmPackage: "@salesforce/dev-scripts"
      - run: echo "dev scripts latest is ${{ steps.version-info.outputs.version }}"
      - uses: notiz-dev/github-action-json-property@2192e246737701f108a4571462b76c75e7376216
        id: packageVersion
        with:
          path: "package.json"
          prop_path: "version"
        run: echo "this repo has version is ${{ steps.packageVersion.outputs.prop }}"

  updateDevScripts:
    needs: [compareVersions]
    if: needs.compareVersions.outputs.shouldUpdate
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.SF_CLI_BOT_GITHUB_TOKEN }}
      - uses: salesforcecli/github-workflows/.github/actions/gitConfig@main

      - uses: actions/setup-node@v3
        with:
          node-version: latest
          cache: yarn
      - run: npm install -g yarn-deduplicate
      - run: yarn upgrade @salesforce/dev-scripts@latest
      # this may fail because that's how dev-scripts does things
      - run: yarn install --network-timeout 600000
        continue-on-error: true

      - run: yarn install --network-timeout 600000
      - run: npx yarn-deduplicate
      - run: yarn install --network-timeout 600000

      # this may fail but we still want a PR with partial fix
      - run: |
          git checkout -b devScripts$(date +%F)
          yarn lint --fix
        continue-on-error: true
      - run: |
          git add .
          git commit -m 'chore: updates from devScripts' --no-verify
          git push origin --no-verify
          sleep 60
          gh pr create --title 'devScripts update' --body 'created via github action.' -l dependencies
        env:
          GH_TOKEN: ${{ secrets.SF_CLI_BOT_GITHUB_TOKEN }}
